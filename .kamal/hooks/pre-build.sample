#!/bin/sh
# Pre-build hook: checks that the repo is in a good state before deploying.

# Abort if there are uncommitted changes
if [ -n "$(git status --porcelain)" ]; then
  echo "Git checkout is not clean, aborting..." >&2
  git status --porcelain >&2
  exit 1
fi

# Abort if there’s no git remote
first_remote=$(git remote)
if [ -z "$first_remote" ]; then
  echo "No git remote set, aborting..." >&2
  exit 1
fi

# Abort if not on a branch
current_branch=$(git branch --show-current)
if [ -z "$current_branch" ]; then
  echo "Not on a git branch, aborting..." >&2
  exit 1
fi

# Abort if the branch hasn’t been pushed
remote_head=$(git ls-remote $first_remote --tags $current_branch | cut -f1)
if [ -z "$remote_head" ]; then
  echo "Branch not pushed to remote, aborting..." >&2
  exit 1
fi

# Abort if the version doesn’t match the remote HEAD
if [ "$KAMAL_VERSION" != "$remote_head" ]; then
  echo "Version ($KAMAL_VERSION) does not match remote HEAD ($remote_head), aborting..." >&2
  exit 1
fi

# All checks passed
exit 0
